<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeGuru</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --error: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background-color: var(--dark);
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        h2 {
            margin-bottom: 1rem;
            color: var(--dark);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
        }
        
        .btn-secondary:hover {
            background-color: #0da271;
        }
        
        .editor-container {
            position: relative;
            font-family: monospace;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            height: 400px;
            margin-bottom: 1rem;
        }
        
        #codeEditor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            background-color: transparent;
            color: #000;
            z-index: 2;
            border: none;
            outline: none;
        }
        
        #ghostText {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #aaa;
            z-index: 1;
            pointer-events: none;
            white-space: pre;
            overflow: auto;
        }
        
        #outputDisplay {
            padding: 1rem;
            background-color: #f1f5f9;
            border-radius: 0.25rem;
            min-height: 200px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
            height: 400px;
        }
        
        .progress-container {
            width: 100%;
            height: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        #progressBar {
            height: 100%;
            width: 0;
            background-color: var(--secondary);
            transition: width 0.2s;
        }
        
        #promptInput {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            font-family: inherit;
        }
        
        .instructions-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f1f5f9;
            border-radius: 0.25rem;
            border-left: 4px solid var(--secondary);
        }
        
        .instructions-container h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .code-section {
            margin-bottom: 1.5rem;
        }
        
        .code-section h3 {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--dark);
        }
        
        .code-section h3 .status-icon {
            margin-right: 0.5rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .status-pending {
            background-color: #cbd5e1;
        }
        
        .status-active {
            background-color: #fbbf24;
        }
        
        .status-complete {
            background-color: #22c55e;
        }
        
        #loadingIndicator {
            display: none;
            margin-top: 1rem;
            color: var(--gray);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .buttons-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .hint {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #fffbeb;
            border-left: 2px solid #fbbf24;
            font-size: 0.9rem;
        }
        
        .api-key-container {
            margin-bottom: 1.5rem;
        }
        
        #apiKeyInput {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">CodeGuru</div>
        </div>
    </header>
    
    <div class="container">
        <main>
            <div>
                <div class="card api-key-container">
                    <h2>OpenAI API Setup</h2>
                    <p>Enter your OpenAI API key to enable the assistant:</p>
                    <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API key">
                    <p class="hint">Your API key is stored locally in your browser and is never sent to our servers.</p>
                </div>
                
                <div class="card">
                    <h2>What would you like to create?</h2>
                    <input type="text" id="promptInput" placeholder="E.g., 'A login page with HTML, CSS, and form validation'">
                    <button id="generateBtn" class="btn">Generate Structure</button>
                    <div id="loadingIndicator">
                        <span class="loading-spinner"></span>
                        Generating code structure...
                    </div>
                    
                    <div class="instructions-container" id="instructionsContainer" style="display: none;">
                        <h3>Project Structure</h3>
                        <div id="structureOutline"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Current Task</h2>
                    <div id="currentTask">
                        <p>No active task. Generate a structure to begin.</p>
                    </div>
                    
                    <div class="progress-container">
                        <div id="progressBar"></div>
                    </div>
                    
                    <div class="editor-container">
                        <textarea id="codeEditor" placeholder="Your code will appear here..."></textarea>
                        <div id="ghostText"></div>
                    </div>
                    
                    <div class="buttons-container">
                        <button id="runBtn" class="btn">Run Code</button>
                        <button id="skipBtn" class="btn btn-secondary">Skip to Next</button>
                        <button id="hintBtn" class="btn">Get Hint</button>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="card">
                    <h2>Output</h2>
                    <div id="outputDisplay">Your output will appear here...</div>
                </div>
                
                <div class="card">
                    <h2>Project Overview</h2>
                    <div id="projectSections"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const apiKeyInput = document.getElementById('apiKeyInput');
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const instructionsContainer = document.getElementById('instructionsContainer');
        const structureOutline = document.getElementById('structureOutline');
        const codeEditor = document.getElementById('codeEditor');
        const ghostText = document.getElementById('ghostText');
        const outputDisplay = document.getElementById('outputDisplay');
        const currentTask = document.getElementById('currentTask');
        const projectSections = document.getElementById('projectSections');
        const progressBar = document.getElementById('progressBar');
        const runBtn = document.getElementById('runBtn');
        const skipBtn = document.getElementById('skipBtn');
        const hintBtn = document.getElementById('hintBtn');

        let projectStructure = [];
        let currentSectionIndex = -1;
        let completeCode = '';
        let isGhostTextVisible = false;
        let currentCompletionIndex = 0;
        let apiKey = localStorage.getItem('openaiApiKey') || '';
        let storedCodeResults = {};

        init();

        function init() {
            if (apiKey) {
                apiKeyInput.value = apiKey;
            }

            apiKeyInput.addEventListener('change', saveApiKey);
            generateBtn.addEventListener('click', generateProjectStructure);
            codeEditor.addEventListener('input', handleCodeEditorInput);
            runBtn.addEventListener('click', runCode);
            skipBtn.addEventListener('click', moveToNextSection);
            hintBtn.addEventListener('click', showHint);
            codeEditor.disabled = true;
        }

        function saveApiKey() {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('openaiApiKey', apiKey);
        }

        async function generateProjectStructure() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                alert('Please enter what you want to create.');
                return;
            }
            
            if (!apiKey) {
                alert('Please enter your OpenAI API key.');
                return;
            }
            loadingIndicator.style.display = 'block';
            generateBtn.disabled = true;
            
            try {
                const structure = await callOpenAIAPI(prompt);
                projectStructure = structure;
                displayProjectStructure();
                currentSectionIndex = -1;
                moveToNextSection();
                instructionsContainer.style.display = 'block';

                codeEditor.disabled = false;
            } catch (error) {
                console.error('Error generating structure:', error);
                alert(`Error: ${error.message || 'Failed to generate structure. Please try again.'}`);
            } finally {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        async function callOpenAIAPI(prompt) {
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4',
                messages: [
                    {
                        role: 'system',
                        content: `You are a coding assistant that provides clean, working implementation code.
                        Focus on writing code that directly solves the problem with minimal explanations.
                        
                        Format your response as follows:
                        
                        ## Section Title
                        Brief description of what this code does (1-2 sentences).
                        
                        \`\`\`language
                        // Clean, working implementation code here
                        \`\`\`
                        
                        Hint: A short hint about the implementation
                        
                        - Provide complete, well-formatted code that can run immediately
                        - Do NOT include setup instructions or explanations of tools
                        - Include necessary comments within the code
                        - Make sure all code is properly indented and formatted`
                    },
                    {
                        role: 'user',
                        content: `Generate code for: ${prompt}. 
                        Split into logical sections (HTML, CSS, JS, etc).
                        Focus on providing working, runnable code without lengthy explanations.`
                    }
                ],
                temperature: 0.5
            })
        });
        
        if (!response.ok) {
            let errorMessage = `API request failed with status ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.error?.message || errorMessage;
            } catch (e) {}
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        return processOpenAIResponse(content);
    } catch (error) {
        throw new Error(`OpenAI API error: ${error.message}`);
    }
}

        function processOpenAIResponse(content) {
            // Default section if parsing fails
            const defaultSection = {
                title: "Generated Code",
                description: "The AI generated the following content:",
                code: content,
                hint: "Follow the code structure shown in the ghost text."
            };
            
            try {
                // First, try to parse as JSON directly
                try {
                    const jsonData = JSON.parse(content);
                    if (Array.isArray(jsonData) && jsonData.length > 0 && jsonData[0].title) {
                        return jsonData;
                    }
                } catch (e) {
                    // Not JSON, continue with markdown parsing
                }
                
                // Look for markdown section headers (## Section Title)
                const sections = [];
                const sectionMatches = content.split(/(?=##\s+)/);
                
                // Skip first element if it's empty
                const startIndex = sectionMatches[0].trim() === '' ? 1 : 0;
                
                for (let i = startIndex; i < sectionMatches.length; i++) {
                    const section = sectionMatches[i].trim();
                    if (!section) continue;
                    
                    // Extract title from ## heading
                    const titleMatch = section.match(/^##\s+(.+?)(?:\n|\r\n|$)/);
                    if (!titleMatch) continue;
                    
                    const title = titleMatch[1].trim();
                    const sectionContent = section.substring(titleMatch[0].length).trim();
                    
                    // Extract code block 
                    const codeBlockMatch = sectionContent.match(/```(?:\w+)?\s*([\s\S]*?)```/);
                    
                    let description, code, hint;
                    
                    if (codeBlockMatch) {
                        // Get text before code block as description
                        const beforeCodeIndex = sectionContent.indexOf('```');
                        description = sectionContent.substring(0, beforeCodeIndex).trim();
                        
                        // Get code from inside code block
                        code = codeBlockMatch[1].trim();
                        
                        // Get text after code block as hint
                        const afterCodeIndex = sectionContent.indexOf('```', beforeCodeIndex + 3);
                        const endCodeIndex = sectionContent.indexOf('```', afterCodeIndex + 3);
                        const endIndex = endCodeIndex > 0 ? endCodeIndex : sectionContent.length;
                        hint = sectionContent.substring(afterCodeIndex + 3, endIndex).trim();
                    } else {
                        // No code block found
                        description = sectionContent;
                        code = "// No code provided for this section";
                        hint = "Follow the instructions carefully.";
                    }
                    
                    sections.push({
                        title,
                        description,
                        code,
                        hint
                    });
                }
                
                if (sections.length > 0) {
                    return sections;
                }
                
                // If we couldn't parse sections but found code blocks, extract them
                const codeBlocks = [];
                let codeBlockRegex = /```(?:\w+)?\s*([\s\S]*?)```/g;
                let codeMatch;
                
                while ((codeMatch = codeBlockRegex.exec(content)) !== null) {
                    codeBlocks.push({
                        title: `Code Block ${codeBlocks.length + 1}`,
                        description: "Implementation code:",
                        code: codeMatch[1].trim(),
                        hint: "Type the code exactly as shown."
                    });
                }
                
                if (codeBlocks.length > 0) {
                    return codeBlocks;
                }
                
                // If all else fails, return the entire content as a single section
                return [defaultSection];
            } catch (error) {
                console.error("Error processing AI response:", error);
                return [defaultSection];
            }
        }
        function displayProjectStructure() {
            // Display overview
            let overviewHTML = '<h3>Project Sections:</h3><ul>';
            projectStructure.forEach((section, index) => {
                overviewHTML += `
                    <li class="code-section">
                        <h3>
                            <span class="status-icon status-pending"></span>
                            ${section.title}
                        </h3>
                    </li>
                `;
            });
            overviewHTML += '</ul>';
            projectSections.innerHTML = overviewHTML;
            
            // Display structure outline
            let outlineHTML = '<ul>';
            projectStructure.forEach(section => {
                outlineHTML += `<li><strong>${section.title}:</strong> ${section.description}</li>`;
            });
            outlineHTML += '</ul>';
            structureOutline.innerHTML = outlineHTML;
        }

        function updateSectionStatus(index, status) {
            const sections = projectSections.querySelectorAll('.code-section');
            
            if (sections[index]) {
                const statusIcon = sections[index].querySelector('.status-icon');
                statusIcon.className = 'status-icon status-' + status;
            }
        }
        function moveToNextSection() {
            // Mark current section as complete if exists
            if (currentSectionIndex >= 0) {
                updateSectionStatus(currentSectionIndex, 'complete');
            }
            
            // Move to next section
            currentSectionIndex++;
            
            // Check if we still have sections
            if (currentSectionIndex < projectStructure.length) {
                const section = projectStructure[currentSectionIndex];
                
                // Update current task - just show title and description
                currentTask.innerHTML = `
                    <h3>${section.title}</h3>
                    <p>${section.description}</p>
                `;
                
                // Mark this section as active
                updateSectionStatus(currentSectionIndex, 'active');
                
                // Reset editor for new section
                codeEditor.value = '';
                ghostText.textContent = '';
                
                // Set the complete code for the current section
                completeCode = section.code;
                
                // Reset completion index
                currentCompletionIndex = 0;
                
                // Initially hide ghost text but set up event to show it on focus
                isGhostTextVisible = false;
                codeEditor.addEventListener('focus', function onFirstFocus() {
                    if (!isGhostTextVisible && codeEditor.value === '') {
                        isGhostTextVisible = true;
                        updateGhostText();
                    }
                    // Remove the event listener after first focus
                    codeEditor.removeEventListener('focus', onFirstFocus);
                });
                
                // Reset progress bar
                updateProgress(0);
                
                // Focus the editor
                codeEditor.focus();
            } else {
                // Project complete
                currentTask.innerHTML = `
                    <h3>ðŸŽ‰ Project Complete!</h3>
                    <p>You've successfully completed all sections of this project.</p>
                `;
                codeEditor.disabled = true;
                skipBtn.disabled = true;
            }
        }
        function updateGhostText() {
            // If we've reached the end of the code, hide ghost text
            if (currentCompletionIndex >= completeCode.length) {
                ghostText.textContent = '';
                isGhostTextVisible = false;
                return;
            }
            
            const userInput = codeEditor.value;
            
            // Show all remaining code as ghost text
            ghostText.textContent = userInput + completeCode.substring(currentCompletionIndex);
            ghostText.scrollTop = codeEditor.scrollTop;
            isGhostTextVisible = true;
        }
        async function callOpenAIAPI(prompt) {
            // Determine if the user is specifically asking for only HTML, CSS, or JS
            let codeType = "full";
            let promptLower = prompt.toLowerCase();
            
            if (promptLower.includes("html only") || 
                promptLower.includes("just html") || 
                promptLower.includes("only html")) {
                codeType = "html_only";
            } else if (promptLower.includes("css only") || 
                promptLower.includes("just css") || 
                promptLower.includes("only css")) {
                codeType = "css_only";
            } else if (promptLower.includes("javascript only") || 
                promptLower.includes("just javascript") || 
                promptLower.includes("only javascript") ||
                promptLower.includes("js only")) {
                codeType = "js_only";
            }
            
            // Create appropriate system prompt based on code type
            let systemPrompt = '';
            
            switch(codeType) {
                case "html_only":
                    systemPrompt = `You are a coding assistant that provides clean HTML code only.
                    Do NOT include any CSS or JavaScript - focus only on HTML structure.
                    
                    Format your response as follows:
                    
                    ## HTML Structure
                    Brief description of the HTML structure.
                    
                    \`\`\`html
                    <!-- Clean, semantic HTML code here -->
                    \`\`\`
                    
                    Hint: A short hint about the HTML structure`;
                    break;
                    
                case "css_only":
                    systemPrompt = `You are a coding assistant that provides clean CSS code only.
                    Do NOT include any HTML or JavaScript - focus only on CSS styling.
                    
                    Format your response as follows:
                    
                    ## CSS Styles
                    Brief description of the styling.
                    
                    \`\`\`css
                    /* Clean CSS code here */
                    \`\`\`
                    
                    Hint: A short hint about the CSS implementation`;
                    break;
                    
                case "js_only":
                    systemPrompt = `You are a coding assistant that provides clean JavaScript code only.
                    Do NOT include any HTML or CSS - focus only on JavaScript functionality.
                    
                    Format your response as follows:
                    
                    ## JavaScript Functionality
                    Brief description of what this code does.
                    
                    \`\`\`javascript
                    // Clean JavaScript code here
                    \`\`\`
                    
                    Hint: A short hint about the JavaScript implementation`;
                    break;
                    
                default:
                    systemPrompt = `You are a coding assistant that provides clean, working implementation code.
                    Focus on writing code that directly solves the problem with minimal explanations.
                    
                    Format your response as follows:
                    
                    ## Section Title
                    Brief description of what this code does (1-2 sentences).
                    
                    \`\`\`language
                    // Clean, working implementation code here
                    \`\`\`
                    
                    Hint: A short hint about the implementation
                    
                    - Split code into separate sections for HTML, CSS, and JavaScript if needed
                    - Do NOT include setup instructions or explanations of tools
                    - Make sure all code is properly indented and formatted`;
                    break;
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: systemPrompt
                            },
                            {
                                role: 'user',
                                content: `Generate code for: ${prompt}.
                                Be precise and follow any specific requirements mentioned.`
                            }
                        ],
                        temperature: 0.5
                    })
                });
                
                if (!response.ok) {
                    let errorMessage = `API request failed with status ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {}
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                return processOpenAIResponse(content);
            } catch (error) {
                throw new Error(`OpenAI API error: ${error.message}`);
            }
        }


        function handleCodeEditorInput(e) {
            if (!completeCode) return;
            
            const userInput = codeEditor.value;
            
            // Always show ghost text when user is typing
            isGhostTextVisible = true;
            
            // Check if user input matches expected code so far
            if (userInput.length > 0 && completeCode.startsWith(userInput)) {
                // User typed correctly
                currentCompletionIndex = userInput.length;
                updateGhostText();
                
                // Update progress
                const progress = (currentCompletionIndex / completeCode.length) * 100;
                updateProgress(progress);
                
                // Check if section is complete
                if (currentCompletionIndex === completeCode.length) {
                    // Wait a bit before showing completion message
                    setTimeout(() => {
                        showCompletionMessage();
                    }, 500);
                }
            } else {
                // User typed incorrectly
                codeEditor.style.borderColor = '#ef4444';
                
                // Reset border color after a moment
                setTimeout(() => {
                    codeEditor.style.borderColor = '#ccc';
                }, 500);
            }
        }
        
        function findLastMatchingIndex(input, target) {
            for (let i = input.length; i > 0; i--) {
                if (target.startsWith(input.substring(0, i))) {
                    return i;
                }
            }
            return 0;
        }

        function showCompletionMessage() {
            currentTask.innerHTML += `
                <div class="hint">
                    <strong>Great job!</strong> You've completed this section. Click "Skip to Next" to continue.
                </div>
            `;
        }

        function updateProgress(percentage) {
            progressBar.style.width = `${percentage}%`;
        }

        function runCode() {
            const userCode = codeEditor.value;
            
            // Get language from code block if available
            let language = "unknown";
            if (projectStructure[currentSectionIndex]) {
                const sectionTitle = projectStructure[currentSectionIndex].title.toLowerCase();
                
                if (sectionTitle.includes("python") || sectionTitle.includes("py")) {
                    language = "python";
                } else if (sectionTitle.includes("html")) {
                    language = "html";
                } else if (sectionTitle.includes("css")) {
                    language = "css";
                } else if (sectionTitle.includes("javascript") || sectionTitle.includes("js")) {
                    language = "javascript";
                } else if (completeCode.includes("def ") && completeCode.includes(":")) {
                    language = "python"; // Detect Python by syntax
                } else if (completeCode.includes("function") || completeCode.includes("var ") || 
                           completeCode.includes("let ") || completeCode.includes("const ")) {
                    language = "javascript"; // Detect JavaScript by syntax
                }
            }
            
            // Check if we have stored results for this section
            const sectionId = currentSectionIndex >= 0 ? currentSectionIndex : 'default';
            
            // Show loading indicator in output
            outputDisplay.innerHTML = `<div class="loading-output">
                <span class="loading-spinner"></span>
                <span>Processing code...</span>
            </div>`;
            
            // Browser-executable languages
            if (language === "html" || userCode.includes('<html>') || userCode.includes('<!DOCTYPE html>')) {
                try {
                    outputDisplay.innerHTML = '';
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    outputDisplay.appendChild(iframe);
                    
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    doc.open();
                    doc.write(userCode);
                    doc.close();
                    
                    // Store the result
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: "HTML rendered successfully",
                        language: "html"
                    };
                } catch (error) {
                    outputDisplay.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: `Error: ${error.message}`,
                        language: "html"
                    };
                }
            } 
            // CSS handling
            else if (language === "css" || (userCode.includes('{') && userCode.includes('}') && 
                    !userCode.includes('function') && !userCode.includes('def '))) {
                try {
                    outputDisplay.innerHTML = `
                        <div id="cssDemo" style="padding: 20px; border: 1px dashed #ccc;">
                            <h3>CSS Preview</h3>
                            <p>This is sample text to preview CSS.</p>
                            <button>A Sample Button</button>
                            <div class="box">A sample div with class "box"</div>
                            <ul>
                                <li>List item 1</li>
                                <li>List item 2</li>
                            </ul>
                        </div>
                    `;
                    const styleTag = document.createElement('style');
                    styleTag.textContent = userCode;
                    outputDisplay.appendChild(styleTag);
                    
                    // Store the result
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: "CSS applied successfully",
                        language: "css"
                    };
                } catch (error) {
                    outputDisplay.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: `Error: ${error.message}`,
                        language: "css"
                    };
                }
            }
            // JavaScript handling
            else if (language === "javascript" || userCode.includes('function') || userCode.includes('var ') || 
                    userCode.includes('let ') || userCode.includes('const ')) {
                try {
                    // Create a safe environment to run the JS code
                    outputDisplay.innerHTML = '<div id="jsOutput">JavaScript Output:</div>';
                    
                    const capturedOutput = [];
                    
                    // Create a safe execution context
                    const executeJs = () => {
                        try {
                            const originalLog = console.log;
                            console.log = function(...args) {
                                const output = args.map(arg => 
                                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                                ).join(' ');
                                capturedOutput.push(output);
                                document.getElementById('jsOutput').innerHTML += `<pre>${output}</pre>`;
                                originalLog.apply(console, args);
                            };
                            
                            // Execute the code
                            eval(userCode);
                            
                            // Call main functions if they exist
                            if (typeof run === 'function') run();
                            if (typeof init === 'function') init();
                            if (typeof main === 'function') main();
                            
                            // Restore console.log
                            console.log = originalLog;
                            
                            // If no output was generated, show a message
                            if (capturedOutput.length === 0) {
                                document.getElementById('jsOutput').innerHTML += 
                                    '<p>Code executed successfully without console output.</p>';
                            }
                        } catch(e) {
                            document.getElementById('jsOutput').innerHTML += 
                                `<pre style="color:red">Error: ${e.message}</pre>`;
                            capturedOutput.push(`Error: ${e.message}`);
                        }
                    };
                    
                    // Execute in a try-catch block
                    try {
                        executeJs();
                    } catch (error) {
                        outputDisplay.querySelector('#jsOutput').innerHTML += 
                            `<pre style="color:red">Execution error: ${error.message}</pre>`;
                        capturedOutput.push(`Execution error: ${error.message}`);
                    }
                    
                    // Store the result
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: capturedOutput.length > 0 ? capturedOutput.join('\n') : "Code executed successfully",
                        language: "javascript"
                    };
                } catch (error) {
                    outputDisplay.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                    storedCodeResults[sectionId] = {
                        code: userCode,
                        output: `Error: ${error.message}`,
                        language: "javascript"
                    };
                }
            }
            // Non-browser languages - use OpenAI to execute
            else {
                // Check if we already have stored results for identical code
                if (storedCodeResults[sectionId] && storedCodeResults[sectionId].code === userCode) {
                    displayStoredResult(sectionId);
                    return;
                }
                
                // Use OpenAI to execute/explain the code
                executeCodeWithAI(userCode, language, sectionId);
            }
        }
        function displayStoredResult(sectionId) {
            const result = storedCodeResults[sectionId];
            if (result) {
                displayCodeExecution(result.code, result.output, result.language);
            }
        }
        async function executeCodeWithAI(code, language, sectionId) {
            try {
                outputDisplay.innerHTML = `<div class="loading-output">
                    <span class="loading-spinner"></span>
                    <span>Executing code with AI...</span>
                </div>`;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a code execution assistant. Execute the provided ${language} code and return ONLY the output that would be produced. If there are errors, explain them briefly. Format your response as plain text exactly as it would appear in a console or output window.`
                            },
                            {
                                role: 'user',
                                content: `Execute this ${language} code and show ONLY the output (including any errors):
                                
                                \`\`\`${language}
                                ${code}
                                \`\`\`
                                
                                Respond with ONLY the output text, no explanations or markdown.`
                            }
                        ],
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const output = data.choices[0].message.content;
                
                // Store the result
                storedCodeResults[sectionId] = {
                    code: code,
                    output: output,
                    language: language
                };
                
                // Display the result
                displayCodeExecution(code, output, language);
                
            } catch (error) {
                console.error("Error executing code with AI:", error);
                outputDisplay.innerHTML = `<div class="error">Error executing code: ${error.message}</div>`;
                
                // Still store the error result
                storedCodeResults[sectionId] = {
                    code: code,
                    output: `Error: ${error.message}`,
                    language: language
                };
            }
        }
        function displayCodeExecution(code, output, language) {
            // Format based on language
            if (language === "python") {
                outputDisplay.innerHTML = `
                    <h3>Python Output</h3>
                    <pre class="code-output" style="background-color: #f8f8f8; padding: 10px; border-left: 4px solid #3b82f6; margin-top: 10px;">${output}</pre>
                `;
            } else {
                outputDisplay.innerHTML = `
                    <h3>${language.charAt(0).toUpperCase() + language.slice(1)} Output</h3>
                    <pre class="code-output" style="background-color: #f8f8f8; padding: 10px; border-left: 4px solid #3b82f6; margin-top: 10px;">${output}</pre>
                `;
            }
        }
        
        function showHint() {
            const section = projectStructure[currentSectionIndex];
            
            if (!section) return;
            
            // Add hint to current task
            currentTask.innerHTML += `
                <div class="hint">
                    <strong>Hint:</strong> ${section.hint || 'Look at the ghost text for guidance.'}
                </div>
            `;
            
            // Show next portion of code without revealing everything
            if (currentCompletionIndex < completeCode.length) {
                const nextPortion = completeCode.substring(
                    currentCompletionIndex, 
                    Math.min(currentCompletionIndex + 25, completeCode.length)
                );
                
                currentTask.innerHTML += `
                    <div class="hint">
                        <strong>Next code snippet:</strong> <code>${nextPortion.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>
                    </div>
                `;
                
                // Add only "Show Ghost Text" button - removed the full solution button
                currentTask.innerHTML += `
                    <div class="hint">
                        <button id="showGhostTextBtn" class="btn btn-secondary">
                            Show Ghost Text
                        </button>
                    </div>
                `;
                
                // Add event listener for the button
                document.getElementById('showGhostTextBtn').addEventListener('click', function() {
                    // Make sure ghost text is visible
                    isGhostTextVisible = true;
                    updateGhostText();
                    this.textContent = "Ghost Text Shown";
                    this.disabled = true;
                    setTimeout(() => {
                        this.disabled = false;
                        this.textContent = "Show Ghost Text";
                    }, 3000);
                });
            }
        }
    </script>
</body>
</html>